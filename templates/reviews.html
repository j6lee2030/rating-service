<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë·° - CI Rating Service</title>
    <link rel="stylesheet" href="../static/styles.css">
</head>
<body class="with-subjects-bg">
    <!-- í—¤ë” ë„¤ë¹„ê²Œì´ì…˜ -->
    <header class="header">
        <a href="index.html" class="logo-wrapper">
            <img src="../static/logo.jpg" alt="CI Logo" class="logo">
            <span class="logo-text">CI Rating</span>
        </a>
        <nav class="header-menu">
            <a href="index.html">í™ˆ</a>
            <a href="subjects.html">í‰ê°€í•˜ê¸°</a>
            <button id="logout-btn" onclick="window.logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>
    </header>

    <!-- í˜ì´ì§€ ë¡œë” -->
    <div class="page-loader-overlay" id="page-loader">
        <div class="loader"></div>
    </div>

    <!-- ë¦¬ë·° í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
    <div class="reviews-page">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <h1>ğŸ“š ê³¼ëª©ë³„ ë¦¬ë·°</h1>
            <p>ëª¨ë“  ê³¼ëª©ì˜ ë¦¬ë·°ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="review-tabs">
            <button class="review-tab active" data-tab="all">ì „ì²´ ë¦¬ë·°</button>
            <button class="review-tab" data-tab="my">ë‚´ ë¦¬ë·°</button>
        </div>

        <!-- í•„í„° ì˜ì—­ -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>ê³¼ëª© í•„í„°:</label>
                <select id="subject-filter">
                    <option value="">ì „ì²´ ê³¼ëª©</option>
                </select>
            </div>
            <div class="review-stats" id="review-stats">
                ì´ <strong>0</strong>ê°œì˜ ë¦¬ë·°
            </div>
        </div>

        <!-- ì „ì²´ ë¦¬ë·° íƒ­ -->
        <div class="tab-panel active" id="panel-all">
            <!-- ê³¼ëª©ë³„ ê·¸ë£¹ -->
            <div class="subjects-grid" id="subjects-grid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>

        <!-- ë‚´ ë¦¬ë·° íƒ­ -->
        <div class="tab-panel" id="panel-my">
            <div class="my-reviews-list" id="my-reviews-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../static/db.js"></script>
    <script src="../static/main.js"></script>
    <script>
        // ê³¼ëª© ëª©ë¡
        const SUBJECTS = [
            { value: 'Math', label: 'Math (ìˆ˜í•™)', icon: 'ğŸ”¢' },
            { value: 'Science', label: 'Science (ê³¼í•™)', icon: 'ğŸ”¬' },
            { value: 'English and Literature', label: 'English and Literature (ì˜ì–´)', icon: 'ğŸ“–' },
            { value: 'Individuals and Societies', label: 'Individuals and Societies (ì‚¬íšŒ)', icon: 'ğŸŒ' },
            { value: 'Design', label: 'Design (ë””ìì¸)', icon: 'ğŸ¨' },
            { value: 'Chinese', label: 'Chinese (ì¤‘êµ­ì–´)', icon: 'ğŸ‡¨ğŸ‡³' },
            { value: 'Korean', label: 'Korean (êµ­ì–´)', icon: 'ğŸ‡°ğŸ‡·' },
            { value: 'Spanish', label: 'Spanish (ìŠ¤í˜ì¸ì–´)', icon: 'ğŸ‡ªğŸ‡¸' },
            { value: 'Strings', label: 'Strings (í˜„ì•…)', icon: 'ğŸ»' },
            { value: 'Piano & Guitar', label: 'Piano & Guitar (í”¼ì•„ë…¸ & ê¸°íƒ€)', icon: 'ğŸ¹' },
            { value: 'Vocal music', label: 'Vocal music (ì„±ì•…)', icon: 'ğŸ¤' },
            { value: 'Media Arts', label: 'Media Arts (ë¯¸ë””ì–´ ì•„íŠ¸)', icon: 'ğŸ¬' }
        ];

        let currentUserId = null;
        let allReviews = [];
        let myReviews = [];

        // ë¡œê·¸ì¸ í™•ì¸ ë° ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            const pageLoader = document.getElementById('page-loader');
            pageLoader.style.display = 'flex';

            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.auth) {
                const isValid = await window.auth.checkSessionValidity();
                if (!isValid) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = await window.auth.getCurrentUser();
                if (!currentUser) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUserId = currentUser.id;
                console.log('âœ… ë¡œê·¸ì¸ í™•ì¸ë¨:', currentUser.email);
            } else {
                alert('ì¸ì¦ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                window.location.href = 'login.html';
                return;
            }

            // í•„í„° ì˜µì…˜ ì´ˆê¸°í™”
            initFilters();
            
            // íƒ­ ì´ë²¤íŠ¸ ì„¤ì •
            setupTabs();
            
            // ë°ì´í„° ë¡œë“œ
            await loadAllData();
            
            pageLoader.style.display = 'none';
        });

        // í•„í„° ì´ˆê¸°í™”
        function initFilters() {
            const filterSelect = document.getElementById('subject-filter');
            SUBJECTS.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.value;
                option.textContent = subject.label;
                filterSelect.appendChild(option);
            });

            filterSelect.addEventListener('change', () => {
                renderCurrentTab();
            });
        }

        // íƒ­ ì„¤ì •
        function setupTabs() {
            const tabs = document.querySelectorAll('.review-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
                    
                    renderCurrentTab();
                });
            });
        }

        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            try {
                console.log('ğŸ“¥ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                console.log('í˜„ì¬ ì‚¬ìš©ì ID:', currentUserId);
                
                // ì „ì²´ ë¦¬ë·° ë¡œë“œ
                const allResult = await window.comments.getAllPublic();
                console.log('ì „ì²´ ë¦¬ë·° ê²°ê³¼:', allResult);
                
                if (allResult.success) {
                    allReviews = allResult.data || [];
                    console.log(`âœ… ì „ì²´ ë¦¬ë·° ${allReviews.length}ê°œ ë¡œë“œë¨`);
                } else {
                    console.error('âŒ ì „ì²´ ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', allResult.error);
                }

                // ë‚´ ë¦¬ë·°ëŠ” ì „ì²´ ë¦¬ë·°ì—ì„œ í•„í„°ë§ (user_idê°€ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„° í˜¸í™˜)
                myReviews = allReviews.filter(r => r.user_id === currentUserId);
                console.log(`âœ… ë‚´ ë¦¬ë·° ${myReviews.length}ê°œ í•„í„°ë¨`);

                renderCurrentTab();
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í˜„ì¬ íƒ­ ë Œë”ë§
        function renderCurrentTab() {
            const activeTab = document.querySelector('.review-tab.active').dataset.tab;
            const filterValue = document.getElementById('subject-filter').value;

            if (activeTab === 'all') {
                renderAllReviews(filterValue);
            } else {
                renderMyReviews(filterValue);
            }
        }

        // ì „ì²´ ë¦¬ë·° ë Œë”ë§ (ê³¼ëª©ë³„ ê·¸ë£¹)
        function renderAllReviews(filterValue) {
            const container = document.getElementById('subjects-grid');
            const statsEl = document.getElementById('review-stats');
            
            let filteredReviews = allReviews;
            if (filterValue) {
                filteredReviews = allReviews.filter(r => r.subject === filterValue);
            }

            statsEl.innerHTML = `ì´ <strong>${filteredReviews.length}</strong>ê°œì˜ ë¦¬ë·°`;

            if (filteredReviews.length === 0) {
                container.innerHTML = '<div class="no-reviews">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™”
            const groupedBySubject = {};
            SUBJECTS.forEach(s => {
                groupedBySubject[s.value] = { ...s, reviews: [] };
            });
            
            filteredReviews.forEach(review => {
                if (groupedBySubject[review.subject]) {
                    groupedBySubject[review.subject].reviews.push(review);
                }
            });

            // ë Œë”ë§
            let html = '';
            
            if (filterValue) {
                // í•„í„° ì ìš© ì‹œ ë‹¨ì¼ ê³¼ëª© í‘œì‹œ
                const subjectData = groupedBySubject[filterValue];
                if (subjectData && subjectData.reviews.length > 0) {
                    html = renderSubjectCard(subjectData, true);
                }
            } else {
                // ì „ì²´ ê³¼ëª© ê·¸ë¦¬ë“œ
                Object.values(groupedBySubject).forEach(subjectData => {
                    if (subjectData.reviews.length > 0) {
                        html += renderSubjectCard(subjectData, false);
                    }
                });
            }

            container.innerHTML = html || '<div class="no-reviews">ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        // ê³¼ëª© ì¹´ë“œ ë Œë”ë§
        function renderSubjectCard(subjectData, expanded) {
            const reviews = subjectData.reviews;
            const avgDifficulty = (reviews.reduce((a, r) => a + r.difficulty, 0) / reviews.length).toFixed(1);
            const avgLecture = (reviews.reduce((a, r) => a + r.lecture_style, 0) / reviews.length).toFixed(1);
            const avgEngaging = (reviews.reduce((a, r) => a + r.engaging_level, 0) / reviews.length).toFixed(1);

            let reviewsHtml = '';
            const displayReviews = expanded ? reviews : reviews.slice(0, 3);
            
            displayReviews.forEach(review => {
                const isMyReview = review.user_id === currentUserId;
                reviewsHtml += renderReviewItem(review, isMyReview);
            });

            const moreCount = reviews.length - 3;
            const showMoreBtn = !expanded && moreCount > 0 
                ? `<button class="show-more-btn" onclick="expandSubject('${subjectData.value}')">+${moreCount}ê°œ ë”ë³´ê¸°</button>` 
                : '';

            return `
                <div class="subject-card ${expanded ? 'expanded' : ''}">
                    <div class="subject-header">
                        <div class="subject-title">
                            <span class="subject-icon">${subjectData.icon}</span>
                            <h3>${subjectData.label}</h3>
                            <span class="review-count">${reviews.length}ê°œ</span>
                        </div>
                        <div class="subject-averages">
                            <span class="avg-chip" title="í‰ê·  ë‚œì´ë„">ë‚œì´ë„ ${avgDifficulty}</span>
                            <span class="avg-chip" title="í‰ê·  ê°•ì˜ ìŠ¤íƒ€ì¼">ê°•ì˜ ${avgLecture}</span>
                            <span class="avg-chip" title="í‰ê·  í¥ë¯¸ë„">í¥ë¯¸ ${avgEngaging}</span>
                        </div>
                    </div>
                    <div class="subject-reviews">
                        ${reviewsHtml}
                    </div>
                    ${showMoreBtn}
                </div>
            `;
        }

        // ë¦¬ë·° ì•„ì´í…œ ë Œë”ë§
        function renderReviewItem(review, isMyReview) {
            const actionsHtml = isMyReview ? `
                <div class="review-actions">
                    <button onclick="editReview('${review.id}')" class="edit-btn">ìˆ˜ì •</button>
                    <button onclick="deleteReview('${review.id}')" class="delete-btn">ì‚­ì œ</button>
                </div>
            ` : '';
            
            const myBadge = isMyReview ? '<span class="my-badge">ë‚´ ë¦¬ë·°</span>' : '';

            return `
                <div class="review-item ${isMyReview ? 'my-review' : ''}">
                    <div class="review-top">
                        <div class="review-meta">
                            ${myBadge}
                            <span class="review-date">${new Date(review.created_at).toLocaleDateString('ko-KR')}</span>
                        </div>
                        <div class="review-stars">
                            <span>ë‚œì´ë„ ${'â˜…'.repeat(review.difficulty)}${'â˜†'.repeat(5-review.difficulty)}</span>
                            <span>ê°•ì˜ ${'â˜…'.repeat(review.lecture_style)}${'â˜†'.repeat(5-review.lecture_style)}</span>
                            <span>í¥ë¯¸ ${'â˜…'.repeat(review.engaging_level)}${'â˜†'.repeat(5-review.engaging_level)}</span>
                        </div>
                    </div>
                    <div class="review-text">${review.reason}</div>
                    ${actionsHtml}
                </div>
            `;
        }

        // ê³¼ëª© í™•ì¥
        window.expandSubject = function(subjectValue) {
            document.getElementById('subject-filter').value = subjectValue;
            renderCurrentTab();
        }

        // ë‚´ ë¦¬ë·° ë Œë”ë§
        function renderMyReviews(filterValue) {
            const container = document.getElementById('my-reviews-list');
            const statsEl = document.getElementById('review-stats');
            
            let filteredReviews = myReviews;
            if (filterValue) {
                filteredReviews = myReviews.filter(r => r.subject === filterValue);
            }

            statsEl.innerHTML = `ë‚´ ë¦¬ë·° <strong>${filteredReviews.length}</strong>ê°œ`;

            if (filteredReviews.length === 0) {
                container.innerHTML = `
                    <div class="no-reviews">
                        <p>ì•„ì§ ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="subjects.html" class="write-review-btn">ë¦¬ë·° ì‘ì„±í•˜ê¸°</a>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredReviews.forEach(review => {
                const subject = SUBJECTS.find(s => s.value === review.subject);
                html += `
                    <div class="my-review-card">
                        <div class="my-review-header">
                            <div class="my-review-subject">
                                <span class="subject-icon">${subject?.icon || 'ğŸ“š'}</span>
                                <strong>${subject?.label || review.subject}</strong>
                            </div>
                            <span class="review-date">${new Date(review.created_at).toLocaleDateString('ko-KR')}</span>
                        </div>
                        <div class="my-review-ratings">
                            <span>ë‚œì´ë„ ${'â˜…'.repeat(review.difficulty)}${'â˜†'.repeat(5-review.difficulty)}</span>
                            <span>ê°•ì˜ ${'â˜…'.repeat(review.lecture_style)}${'â˜†'.repeat(5-review.lecture_style)}</span>
                            <span>í¥ë¯¸ ${'â˜…'.repeat(review.engaging_level)}${'â˜†'.repeat(5-review.engaging_level)}</span>
                        </div>
                        <div class="my-review-text">${review.reason}</div>
                        <div class="my-review-actions">
                            <button onclick="editReview('${review.id}')" class="edit-btn">ìˆ˜ì •</button>
                            <button onclick="deleteReview('${review.id}')" class="delete-btn">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ë¦¬ë·° ìˆ˜ì •
        window.editReview = async function(reviewId) {
            // subjects.htmlë¡œ ì´ë™í•˜ë©´ì„œ ìˆ˜ì • ëª¨ë“œ ì„¤ì •
            sessionStorage.setItem('editReviewId', reviewId);
            window.location.href = 'subjects.html';
        }

        // ë¦¬ë·° ì‚­ì œ
        window.deleteReview = async function(reviewId) {
            if (!confirm('ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const result = await window.comments.delete(reviewId);
                if (result.success) {
                    await loadAllData();
                } else {
                    alert(result.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
            }
        }
    </script>
</body>
</html>

