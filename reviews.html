<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews - CI Rating Service</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body class="with-subjects-bg">
    <!-- Header Navigation -->
    <header class="header">
        <a href="index.html" class="logo-wrapper">
            <img src="static/logo.jpg" alt="CI Logo" class="logo">
            <span class="logo-text">CI Rating</span>
        </a>
        <nav class="header-menu">
            <a href="index.html">Home</a>
            <a href="subjects.html">Rate</a>
            <button class="dark-mode-toggle" aria-label="Toggle dark mode">ðŸŒ™</button>
            <button id="logout-btn" onclick="window.logout()">Logout</button>
        </nav>
    </header>

    <!-- Page Loader -->
    <div class="page-loader-overlay" id="page-loader">
        <div class="loader"></div>
    </div>

    <!-- Reviews Page Container -->
    <div class="reviews-page">
        <!-- Page Header -->
        <div class="page-header">
            <h1>ðŸ“š Subject Reviews</h1>
            <p>View all subject reviews at a glance</p>
        </div>

        <!-- Tab Navigation -->
        <div class="review-tabs">
            <button class="review-tab active" data-tab="all">All Reviews</button>
            <button class="review-tab" data-tab="my">My Reviews</button>
        </div>

        <!-- Filter Area -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Grade Filter:</label>
                <select id="grade-filter">
                    <option value="">All Grades</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Subject Filter:</label>
                <select id="subject-filter">
                    <option value="">All Subjects</option>
                </select>
            </div>
            <div class="review-stats" id="review-stats">
                Total <strong>0</strong> reviews
            </div>
        </div>

        <!-- All Reviews Tab -->
        <div class="tab-panel active" id="panel-all">
            <!-- Subject Groups -->
            <div class="subjects-grid" id="subjects-grid">
                <!-- Dynamically generated -->
            </div>
        </div>

        <!-- My Reviews Tab -->
        <div class="tab-panel" id="panel-my">
            <div class="my-reviews-list" id="my-reviews-list">
                <!-- Dynamically generated -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="static/db.js"></script>
    <script src="static/main.js"></script>
    <script>
        // Subject list
        const SUBJECTS = [
            { value: 'Math', label: 'Math', icon: 'ðŸ”¢' },
            { value: 'Science', label: 'Science', icon: 'ðŸ”¬' },
            { value: 'English and Literature', label: 'English and Literature', icon: 'ðŸ“–' },
            { value: 'Individuals and Societies', label: 'Individuals and Societies', icon: 'ðŸŒ' },
            { value: 'Design', label: 'Design', icon: 'ðŸŽ¨' },
            { value: 'Chinese', label: 'Chinese', icon: 'ðŸ‡¨ðŸ‡³' },
            { value: 'Korean', label: 'Korean', icon: 'ðŸ‡°ðŸ‡·' },
            { value: 'Spanish', label: 'Spanish', icon: 'ðŸ‡ªðŸ‡¸' },
            { value: 'Strings', label: 'Strings', icon: 'ðŸŽ»' },
            { value: 'Piano & Guitar', label: 'Piano & Guitar', icon: 'ðŸŽ¹' },
            { value: 'Vocal music', label: 'Vocal music', icon: 'ðŸŽ¤' },
            { value: 'Media Arts', label: 'Media Arts', icon: 'ðŸŽ¬' }
        ];

        let currentUserId = null;
        let allReviews = [];
        let myReviews = [];

        // Check login and initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const pageLoader = document.getElementById('page-loader');
            pageLoader.style.display = 'flex';

            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.auth) {
                const isValid = await window.auth.checkSessionValidity();
                if (!isValid) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = await window.auth.getCurrentUser();
                if (!currentUser) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUserId = currentUser.id;
                console.log('âœ… Login confirmed:', currentUser.email);
            } else {
                alert('Authentication system is unavailable');
                window.location.href = 'login.html';
                return;
            }

            // Initialize filter options
            initFilters();
            
            // Set up tab events
            setupTabs();
            
            // Load data
            await loadAllData();
            
            pageLoader.style.display = 'none';
        });

        // Initialize filters
        function initFilters() {
            const subjectFilterSelect = document.getElementById('subject-filter');
            const gradeFilterSelect = document.getElementById('grade-filter');

            SUBJECTS.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.value;
                option.textContent = subject.label;
                subjectFilterSelect.appendChild(option);
            });

            subjectFilterSelect.addEventListener('change', () => {
                renderCurrentTab();
            });

            gradeFilterSelect.addEventListener('change', () => {
                renderCurrentTab();
            });
        }

        // Set up tabs
        function setupTabs() {
            const tabs = document.querySelectorAll('.review-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
                    
                    renderCurrentTab();
                });
            });
        }

        // Load all data
        async function loadAllData() {
            try {
                console.log('ðŸ“¥ Starting data load...');
                console.log('Current user ID:', currentUserId);

                // Load all reviews (without filtering)
                const allResult = await window.comments.getAllPublic();
                console.log('All reviews result:', allResult);
                
                if (allResult.success) {
                    allReviews = allResult.data || [];
                    console.log(`âœ… Loaded ${allReviews.length} reviews`);
                } else {
                    console.error('âŒ Failed to load reviews:', allResult.error);
                }

                // Filter my reviews from all reviews (compatible with existing data without user_id)
                myReviews = allReviews.filter(r => r.user_id === currentUserId);
                console.log(`âœ… Filtered ${myReviews.length} of my reviews`);

                renderCurrentTab();
            } catch (error) {
                console.error('âŒ Data load error:', error);
            }
        }

        // Render current tab
        function renderCurrentTab() {
            const activeTab = document.querySelector('.review-tab.active').dataset.tab;
            const subjectFilterValue = document.getElementById('subject-filter').value;
            const gradeFilterValue = document.getElementById('grade-filter').value;

            if (activeTab === 'all') {
                renderAllReviews(subjectFilterValue, gradeFilterValue);
            } else {
                renderMyReviews(subjectFilterValue, gradeFilterValue);
            }
        }

        // Render all reviews (grouped by subject)
        function renderAllReviews(subjectFilter, gradeFilter) {
            const container = document.getElementById('subjects-grid');
            const statsEl = document.getElementById('review-stats');

            let filteredReviews = allReviews;

            // Subject filtering
            if (subjectFilter) {
                filteredReviews = filteredReviews.filter(r => r.subject === subjectFilter);
            }

            // Grade filtering
            if (gradeFilter) {
                filteredReviews = filteredReviews.filter(r => r.grade == gradeFilter);
            }

            statsEl.innerHTML = `Total <strong>${filteredReviews.length}</strong> reviews`;

            if (filteredReviews.length === 0) {
                container.innerHTML = '<div class="no-reviews">No reviews have been written yet.</div>';
                return;
            }

            // Group by subject
            const groupedBySubject = {};
            SUBJECTS.forEach(s => {
                groupedBySubject[s.value] = { ...s, reviews: [] };
            });
            
            filteredReviews.forEach(review => {
                if (groupedBySubject[review.subject]) {
                    groupedBySubject[review.subject].reviews.push(review);
                }
            });

            // Render
            let html = '';
            
            if (subjectFilter) {
                // Show single subject when filter is applied
                const subjectData = groupedBySubject[subjectFilter];
                if (subjectData && subjectData.reviews.length > 0) {
                    html = renderSubjectCard(subjectData, true);
                }
            } else {
                // All subjects grid
                Object.values(groupedBySubject).forEach(subjectData => {
                    if (subjectData.reviews.length > 0) {
                        html += renderSubjectCard(subjectData, false);
                    }
                });
            }

            container.innerHTML = html || '<div class="no-reviews">No reviews have been written yet.</div>';
        }

        // Render subject card
        function renderSubjectCard(subjectData, expanded) {
            const reviews = subjectData.reviews;
            const avgDifficulty = (reviews.reduce((a, r) => a + r.difficulty, 0) / reviews.length).toFixed(1);
            const avgLecture = (reviews.reduce((a, r) => a + r.lecture_style, 0) / reviews.length).toFixed(1);
            const avgEngaging = (reviews.reduce((a, r) => a + r.engaging_level, 0) / reviews.length).toFixed(1);

            let reviewsHtml = '';
            const displayReviews = expanded ? reviews : reviews.slice(0, 3);
            
            displayReviews.forEach(review => {
                const isMyReview = review.user_id === currentUserId;
                reviewsHtml += renderReviewItem(review, isMyReview);
            });

            const moreCount = reviews.length - 3;
            const showMoreBtn = !expanded && moreCount > 0 
                ? `<button class="show-more-btn" onclick="expandSubject('${subjectData.value}')">+${moreCount} more</button>` 
                : '';

            return `
                <div class="subject-card ${expanded ? 'expanded' : ''}">
                    <div class="subject-header">
                        <div class="subject-title">
                            <span class="subject-icon">${subjectData.icon}</span>
                            <h3>${subjectData.label}</h3>
                            <span class="review-count">${reviews.length}</span>
                        </div>
                        <div class="subject-averages">
                            <span class="avg-chip" title="Average Difficulty">Difficulty ${avgDifficulty}</span>
                            <span class="avg-chip" title="Average Lecture Style">Lecture ${avgLecture}</span>
                            <span class="avg-chip" title="Average Engagement">Engagement ${avgEngaging}</span>
                        </div>
                    </div>
                    <div class="subject-reviews">
                        ${reviewsHtml}
                    </div>
                    ${showMoreBtn}
                </div>
            `;
        }

        // Get grade badge color class
        function getGradeBadgeClass(grade) {
            const gradeClasses = {
                6: 'grade-6',
                7: 'grade-7',
                8: 'grade-8'
            };
            return gradeClasses[grade] || 'grade-unknown';
        }

        // Render review item
        function renderReviewItem(review, isMyReview) {
            const actionsHtml = isMyReview ? `
                <div class="review-actions">
                    <button onclick="editReview('${review.id}')" class="edit-btn">Edit</button>
                    <button onclick="deleteReview('${review.id}')" class="delete-btn">Delete</button>
                </div>
            ` : '';

            const myBadge = isMyReview ? '<span class="my-badge">My Review</span>' : '';
            const gradeBadge = review.grade ? `<span class="grade-badge ${getGradeBadgeClass(review.grade)}">Grade ${review.grade}</span>` : '';

            return `
                <div class="review-item ${isMyReview ? 'my-review' : ''}">
                    <div class="review-top">
                        <div class="review-meta">
                            ${myBadge}
                            ${gradeBadge}
                            <span class="review-date">${new Date(review.created_at).toLocaleDateString('en-US')}</span>
                        </div>
                        <div class="review-stars">
                            <span>Difficulty ${'â˜…'.repeat(review.difficulty)}${'â˜†'.repeat(5-review.difficulty)}</span>
                            <span>Lecture ${'â˜…'.repeat(review.lecture_style)}${'â˜†'.repeat(5-review.lecture_style)}</span>
                            <span>Engagement ${'â˜…'.repeat(review.engaging_level)}${'â˜†'.repeat(5-review.engaging_level)}</span>
                        </div>
                    </div>
                    <div class="review-text">${review.reason}</div>
                    ${actionsHtml}
                </div>
            `;
        }

        // Expand subject
        window.expandSubject = function(subjectValue) {
            document.getElementById('subject-filter').value = subjectValue;
            renderCurrentTab();
        }

        // Render my reviews
        function renderMyReviews(subjectFilter, gradeFilter) {
            const container = document.getElementById('my-reviews-list');
            const statsEl = document.getElementById('review-stats');

            let filteredReviews = myReviews;

            // Subject filtering
            if (subjectFilter) {
                filteredReviews = filteredReviews.filter(r => r.subject === subjectFilter);
            }

            // Grade filtering
            if (gradeFilter) {
                filteredReviews = filteredReviews.filter(r => r.grade == gradeFilter);
            }

            statsEl.innerHTML = `My Reviews <strong>${filteredReviews.length}</strong>`;

            if (filteredReviews.length === 0) {
                container.innerHTML = `
                    <div class="no-reviews">
                        <p>You haven't written any reviews yet.</p>
                        <a href="subjects.html" class="write-review-btn">Write a Review</a>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredReviews.forEach(review => {
                const subject = SUBJECTS.find(s => s.value === review.subject);
                const gradeBadge = review.grade ? `<span class="grade-badge ${getGradeBadgeClass(review.grade)}">Grade ${review.grade}</span>` : '';

                html += `
                    <div class="my-review-card">
                        <div class="my-review-header">
                            <div class="my-review-subject">
                                <span class="subject-icon">${subject?.icon || 'ðŸ“š'}</span>
                                <strong>${subject?.label || review.subject}</strong>
                                ${gradeBadge}
                            </div>
                            <span class="review-date">${new Date(review.created_at).toLocaleDateString('en-US')}</span>
                        </div>
                        <div class="my-review-ratings">
                            <span>Difficulty ${'â˜…'.repeat(review.difficulty)}${'â˜†'.repeat(5-review.difficulty)}</span>
                            <span>Lecture ${'â˜…'.repeat(review.lecture_style)}${'â˜†'.repeat(5-review.lecture_style)}</span>
                            <span>Engagement ${'â˜…'.repeat(review.engaging_level)}${'â˜†'.repeat(5-review.engaging_level)}</span>
                        </div>
                        <div class="my-review-text">${review.reason}</div>
                        <div class="my-review-actions">
                            <button onclick="editReview('${review.id}')" class="edit-btn">Edit</button>
                            <button onclick="deleteReview('${review.id}')" class="delete-btn">Delete</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Edit review
        window.editReview = async function(reviewId) {
            // Navigate to subjects.html with edit mode
            sessionStorage.setItem('editReviewId', reviewId);
            window.location.href = 'subjects.html';
        }

        // Delete review
        window.deleteReview = async function(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;
            
            try {
                const result = await window.comments.delete(reviewId);
                if (result.success) {
                    await loadAllData();
                } else {
                    alert(result.error || 'Delete failed');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Network error');
            }
        }
    </script>
</body>
</html>

