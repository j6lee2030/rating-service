<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Subjects - CI Rating Service</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body class="with-subjects-bg">
    <!-- Header Navigation -->
    <header class="header">
        <a href="index.html" class="logo-wrapper">
            <img src="static/logo.jpg" alt="CI Logo" class="logo">
            <span class="logo-text">CI Rating</span>
        </a>
        <nav class="header-menu">
            <a href="index.html">Home</a>
            <a href="reviews.html">View Reviews</a>
            <button class="dark-mode-toggle" aria-label="Toggle dark mode">ğŸŒ™</button>
            <button id="logout-btn" onclick="window.logout()">Logout</button>
        </nav>
    </header>

    <!-- Page Loader -->
    <div class="page-loader-overlay">
        <div class="loader"></div>
    </div>

    <!-- Main Rating Box -->
    <div class="main-box">
        <h2 class="form-title">ğŸ“ Rate a Subject</h2>
        <p class="form-description">Select your grade and subject, then share your honest review</p>

        <!-- Grade Selection Dropdown -->
        <div class="custom-dropdown grade-dropdown">
            <div class="dropdown-select grade-select">Select Grade</div>
            <div class="dropdown-list grade-list" style="display: none;">
                <div data-value="6">Grade 6</div>
                <div data-value="7">Grade 7</div>
                <div data-value="8">Grade 8</div>
            </div>
        </div>

        <!-- Subject Selection Dropdown -->
        <div class="custom-dropdown subject-dropdown" style="display: none;">
            <div class="dropdown-select subject-select">Select Subject</div>
            <div class="dropdown-list" style="display: none;">
                <div data-value="Math">Math</div>
                <div data-value="Science">Science</div>
                <div data-value="English and Literature">English and Literature</div>
                <div data-value="Individuals and Societies">Individuals and Societies</div>
                <div data-value="Design">Design</div>
                <div data-value="Chinese">Chinese</div>
                <div data-value="Korean">Korean</div>
                <div data-value="Spanish">Spanish</div>
                <div data-value="Strings">Strings</div>
                <div data-value="Piano & Guitar">Piano & Guitar</div>
                <div data-value="Vocal music">Vocal music</div>
                <div data-value="Media Arts">Media Arts</div>
            </div>
        </div>

        <!-- Rating Input Area -->
        <div class="rating-content">
            <div class="rating-system">
                <div class="rating-row">
                    <span class="rating-label">Difficulty</span>
                    <div class="stars" data-rating-type="difficulty">
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                    </div>
                </div>
                <div class="rating-row">
                    <span class="rating-label">Lecture Style</span>
                    <div class="stars" data-rating-type="lecture_style">
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                    </div>
                </div>
                <div class="rating-row">
                    <span class="rating-label">Engagement</span>
                    <div class="stars" data-rating-type="engaging_level">
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                        <span class="star">â˜…</span>
                    </div>
                </div>
            </div>
            
            <!-- Review Writing -->
            <div class="form-bottom">
                <div class="reason-box">
                    <p>Detailed Review</p>
                    <textarea placeholder="Share your honest opinion about this subject..."></textarea>
                    <div class="validation-message">Please enter your review content.</div>
                </div>
                <button class="submit-button">Submit</button>
            </div>
            
            <!-- Loading & Success Message -->
            <div class="loader" id="submit-loader"></div>
            <div class="submitted-message">
                Review submitted successfully! ğŸ‰
                <a href="reviews.html" class="view-reviews-link">View Reviews â†’</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="static/db.js"></script>
    <script src="static/main.js"></script>
    <script>
        // Check login status and load edit review if needed
        document.addEventListener('DOMContentLoaded', async function() {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.auth) {
                const isValid = await window.auth.checkSessionValidity();
                if (!isValid) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = await window.auth.getCurrentUser();
                if (!currentUser) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('âœ… Login confirmed:', currentUser.email);
            } else {
                alert('Authentication system is unavailable');
                window.location.href = 'login.html';
                return;
            }

            // Check if we're in edit mode
            const editReviewId = sessionStorage.getItem('editReviewId');
            if (editReviewId) {
                // Clear the sessionStorage so it doesn't persist
                sessionStorage.removeItem('editReviewId');
                
                // Load the review data
                await loadReviewForEdit(editReviewId);
            }
        });

        // Load review data for editing
        async function loadReviewForEdit(reviewId) {
            try {
                // Get all reviews and find the one we want to edit
                const result = await window.comments.getAll();
                if (result.success && result.data) {
                    const review = result.data.find(r => r.id === reviewId);
                    
                    if (review) {
                        // Set grade
                        currentGrade = review.grade;
                        if (currentGrade) {
                            const gradeText = `Grade ${currentGrade}`;
                            gradeSelect.textContent = gradeText;
                            subjectDropdown.style.display = 'block';
                        }
                        
                        // Set subject
                        currentSubject = review.subject;
                        // Find the subject label from the dropdown
                        const subjectOptions = subjectList.querySelectorAll('div[data-value]');
                        const subjectOption = Array.from(subjectOptions).find(
                            opt => opt.dataset.value === review.subject
                        );
                        if (subjectOption) {
                            subjectSelect.textContent = subjectOption.textContent;
                        } else {
                            subjectSelect.textContent = review.subject;
                        }
                        
                        // Set ratings
                        const difficultyStars = document.querySelector('[data-rating-type="difficulty"]').querySelectorAll('.star');
                        const lectureStars = document.querySelector('[data-rating-type="lecture_style"]').querySelectorAll('.star');
                        const engagingStars = document.querySelector('[data-rating-type="engaging_level"]').querySelectorAll('.star');
                        
                        difficultyStars.forEach((star, index) => {
                            star.classList.toggle('active', index < review.difficulty);
                        });
                        lectureStars.forEach((star, index) => {
                            star.classList.toggle('active', index < review.lecture_style);
                        });
                        engagingStars.forEach((star, index) => {
                            star.classList.toggle('active', index < review.engaging_level);
                        });
                        
                        // Set review text
                        const textarea = document.querySelector('.reason-box textarea');
                        if (textarea) {
                            textarea.value = review.reason;
                        }
                        
                        // Show the form
                        ratingContent.style.display = 'flex';
                        document.querySelector('.form-bottom').style.display = 'block';
                        document.querySelector('.submitted-message').style.display = 'none';
                        document.querySelector('#submit-loader').style.display = 'none';
                        
                        // Set editing state
                        editingCommentId = reviewId;
                        submitButton.textContent = 'Update';
                        
                        console.log('âœ… Review loaded for editing:', reviewId);
                    } else {
                        console.error('Review not found:', reviewId);
                        alert('Review not found');
                    }
                } else {
                    console.error('Failed to load reviews:', result.error);
                    alert('Failed to load review data');
                }
            } catch (error) {
                console.error('Error loading review for edit:', error);
                alert('Failed to load review');
            }
        }

        const gradeSelect = document.querySelector('.grade-select');
        const gradeList = document.querySelector('.grade-list');
        const subjectDropdown = document.querySelector('.subject-dropdown');
        const subjectSelect = document.querySelector('.subject-select');
        // ê³¼ëª© ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ì˜ dropdown-listë§Œ ì„ íƒ (í•™ë…„ ë“œë¡­ë‹¤ìš´ê³¼ êµ¬ë¶„)
        const subjectList = document.querySelector('.subject-dropdown .dropdown-list');
        const ratingContent = document.querySelector('.rating-content');
        const submitButton = document.querySelector('.submit-button');

        let currentGrade = null;

        // Set initial dropdown state
        gradeList.style.display = 'none';
        subjectList.style.display = 'none';

        // Grade dropdown toggle
        gradeSelect.addEventListener('click', () => {
            const isVisible = gradeList.style.display === 'block';
            gradeList.style.display = isVisible ? 'none' : 'block';
            gradeSelect.classList.toggle('open', !isVisible);

            // Close other dropdown
            subjectList.style.display = 'none';
            subjectSelect.classList.remove('open');
        });

        // Grade selection
        gradeList.addEventListener('click', (event) => {
            if (event.target.dataset.value) {
                const selectedGrade = parseInt(event.target.dataset.value);
                gradeSelect.textContent = event.target.textContent;
                currentGrade = selectedGrade;
                gradeList.style.display = 'none';
                gradeSelect.classList.remove('open');

                // Show subject selection dropdown
                subjectDropdown.style.display = 'block';

                // Reset subject dropdown
                subjectSelect.textContent = 'Select Subject';
                currentSubject = null;
                ratingContent.style.display = 'none';
            }
        });

        // Subject dropdown toggle
        subjectSelect.addEventListener('click', () => {
            const isVisible = subjectList.style.display === 'block';
            subjectList.style.display = isVisible ? 'none' : 'block';
            subjectSelect.classList.toggle('open', !isVisible);

            // Close other dropdown
            gradeList.style.display = 'none';
            gradeSelect.classList.remove('open');
        });

        // Subject selection
        subjectList.addEventListener('click', (event) => {
            if (event.target.dataset.value) {
                const selectedSubject = event.target.dataset.value;
                subjectSelect.textContent = event.target.textContent;
                currentSubject = selectedSubject;
                subjectList.style.display = 'none';
                subjectSelect.classList.remove('open');
                ratingContent.style.display = 'flex';

                // Reset form
                document.querySelector('.form-bottom').style.display = 'block';
                document.querySelector('.submitted-message').style.display = 'none';
                document.querySelector('#submit-loader').style.display = 'none';
                document.querySelector('.reason-box textarea').value = '';

                document.querySelectorAll('.star').forEach(star => {
                    star.classList.remove('active');
                });

                editingCommentId = null;
                submitButton.textContent = 'Submit';
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!gradeSelect.contains(event.target) && !gradeList.contains(event.target)) {
                gradeList.style.display = 'none';
                gradeSelect.classList.remove('open');
            }
            if (!subjectSelect.contains(event.target) && !subjectList.contains(event.target)) {
                subjectList.style.display = 'none';
                subjectSelect.classList.remove('open');
            }
        });

        // Star rating click
        document.querySelectorAll('.stars').forEach(starsContainer => {
            starsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('star')) {
                    const stars = starsContainer.querySelectorAll('.star');
                    const selectedIndex = Array.from(stars).indexOf(event.target);
                    stars.forEach((star, index) => {
                        star.classList.toggle('active', index <= selectedIndex);
                    });
                }
            });
        });

        // Submit button click
        submitButton.addEventListener('click', async () => {
            if (!currentUser) {
                const user = await window.auth.getCurrentUser();
                if (!user) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = user;
            }

            if (!currentGrade) {
                alert('Please select a grade first');
                return;
            }

            if (!currentSubject) {
                alert('Please select a subject first');
                return;
            }

            const formBottom = document.querySelector('.form-bottom');
            const validationMessage = document.querySelector('.validation-message');
            const textarea = document.querySelector('.reason-box textarea');
            const loader = document.querySelector('#submit-loader');
            const submittedMessage = document.querySelector('.submitted-message');

            if (textarea.value.trim() === '') {
                validationMessage.style.display = 'block';
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 2000);
                return;
            }

            const difficulty = getRating('difficulty');
            const lectureStyle = getRating('lecture_style');
            const engagingLevel = getRating('engaging_level');

            if (difficulty === 0 || lectureStyle === 0 || engagingLevel === 0) {
                alert('Please rate all items');
                return;
            }

            validationMessage.style.display = 'none';
            formBottom.style.display = 'none';
            loader.style.display = 'block';

            try {
                let result;
                if (editingCommentId) {
                    result = await window.comments.update(editingCommentId, currentSubject, difficulty, lectureStyle, engagingLevel, textarea.value.trim(), currentGrade);
                } else {
                    result = await window.comments.create(currentSubject, difficulty, lectureStyle, engagingLevel, textarea.value.trim(), currentGrade);
                }
                
                loader.style.display = 'none';
                
                if (result.success) {
                    submittedMessage.style.display = 'block';
                } else {
                    console.error('Save error:', result.error);
                    alert(result.error || 'Save failed');
                    formBottom.style.display = 'block';
                }
            } catch (error) {
                console.error('Submit error:', error);
                loader.style.display = 'none';
                alert('Network error');
                formBottom.style.display = 'block';
            }
        });

        function getRating(type) {
            const stars = document.querySelector(`[data-rating-type="${type}"]`).querySelectorAll('.star');
            let count = 0;
            stars.forEach(star => {
                if (star.classList.contains('active')) count++;
            });
            return count;
        }
    </script>
</body>
</html>
